services:
  postgres:
    image: postgres:16-alpine
    container_name: hcscraper-postgres
    environment:
      POSTGRES_USER: hallmark
      POSTGRES_PASSWORD: hallmark
      POSTGRES_DB: hallmark_orders
    volumes:
      # Persist database data on host
      - postgres_data:/var/lib/postgresql/data
    ports:
      # Expose PostgreSQL port to host (optional, for external access)
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hallmark"]
      interval: 10s
      timeout: 5s
      retries: 5

  hcscraper:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hcscraper
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      # Mount data directory so downloaded files are accessible on host
      - ./data:/app/data
      # Mount session directory for persistence across container restarts
      # Note: session file will be created inside this directory
      - ./sessions:/app/sessions
      # Mount logs directory so log files are accessible on host
      - ./logs:/app/logs
      # Mount .env file (make sure it exists on host)
      - ./.env:/app/.env:ro
      # Mount search results directory for CSV-based order extraction
      - ./search_results:/app/search_results:ro
      # Mount debug responses directory for debugging failed API calls
      - ./debug_responses:/app/debug_responses
    environment:
      # Override OUTPUT_DIRECTORY to use mounted volume
      - OUTPUT_DIRECTORY=/app/data
      # Session file path inside the mounted sessions directory
      - SESSION_FILE=/app/sessions/hallmark_session.json
      # Log file path inside the mounted logs directory
      - LOG_FILE=/app/logs/hallmark_scraper.log
      # Default database URL (can be overridden in .env)
      - DATABASE_URL=postgresql://hallmark:hallmark@postgres:5432/hallmark_orders
    # Interactive mode settings (enables MFA input and real-time progress display)
    stdin_open: true  # Allows input (for MFA codes)
    tty: true         # Allocates pseudo-TTY (for formatted output and progress)
    # Note: When using 'docker compose run', use -it flags for explicit interactive mode
    # The stdin_open and tty settings help, but -it is more reliable
    # Example: docker compose run --rm -it hcscraper python main.py --order-id 123

volumes:
  postgres_data:

